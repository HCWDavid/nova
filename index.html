<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NOVA v0.2 | Multi-Modal Video Annotation</title>
    <meta name="description" content="NOVA - Multi-modal nursing video annotation with gaze overlay support">
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Pako for gzip decompression -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <header class="app-header">
            <div class="logo">
                <span class="logo-icon">‚≠ê</span>
                <h1>NOVA</h1>
                <span class="version-badge">v0.2</span>
            </div>
            <div class="header-controls">
                <div class="annotator-info">
                    <label>Annotator:</label>
                    <input type="text" id="annotator-name" placeholder="Your name" value="">
                </div>
                <button id="export-btn" class="btn btn-primary" disabled>
                    <span>üì•</span> Export
                </button>
                <select id="annotation-mode-select" class="mode-select" title="Annotation Mode">
                    <option value="range">üìè Range</option>
                    <option value="pin">üìç Pin</option>
                </select>
                <button id="settings-btn" class="btn btn-icon" title="Settings">
                    ‚öôÔ∏è
                </button>
            </div>
        </header>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Video/Modalities Section -->
            <section class="video-section">
                <!-- Modalities Container (videos with overlays) -->
                <div id="modalities-container" class="modalities-container">
                    <!-- Dynamically generated -->
                </div>

                <!-- Add Modality Bar -->
                <div class="add-modality-bar">
                    <button id="add-modality-btn" class="btn btn-secondary">
                        <span>‚ûï</span> Add Data
                    </button>
                    <input type="file" id="add-modality-input" accept="video/*,.mp4,.mov,.avi,.webm,.csv,.tsv,.txt,.jsonl,.gz" hidden multiple>
                </div>

                <!-- Video Controls -->
                <div class="video-controls">
                    <div class="playback-controls">
                        <button id="play-pause-btn" class="control-btn" title="Play/Pause (Space)">
                            <span id="play-icon">‚ñ∂</span>
                        </button>
                        <button id="frame-back-btn" class="control-btn small" title="Previous Frame (‚Üê)">‚èÆ</button>
                        <button id="frame-forward-btn" class="control-btn small" title="Next Frame (‚Üí)">‚è≠</button>
                        <span class="time-display">
                            <span id="current-time">00:00:00.000</span>
                            <span class="time-separator">/</span>
                            <span id="duration">00:00:00.000</span>
                        </span>
                        <span class="frame-display">
                            Frame: <span id="current-frame">0</span>
                        </span>
                    </div>
                    <div class="speed-controls">
                        <label>Speed:</label>
                        <select id="playback-speed">
                            <option value="0.25">0.25x</option>
                            <option value="0.5">0.5x</option>
                            <option value="1" selected>1x</option>
                            <option value="1.5">1.5x</option>
                            <option value="2">2x</option>
                        </select>
                    </div>
                </div>

                <!-- Annotation Timelines -->
                <div class="timeline-section">
                    <div id="timelines-container">
                        <!-- Dynamically generated -->
                    </div>
                    <input type="range" id="seek-slider" min="0" max="100" value="0" step="0.1">
                </div>
            </section>

            <!-- Resize Handle -->
            <div id="panel-resizer" class="panel-resizer"></div>

            <!-- Annotation Panel -->
            <aside class="annotation-panel">
                <!-- Layer Tabs -->
                <div id="mode-tabs" class="mode-tabs">
                    <!-- Dynamically generated -->
                </div>

                <!-- Annotation Types -->
                <div class="annotation-types" id="annotation-types">
                    <!-- Dynamically generated -->
                </div>

                <!-- Status -->
                <div class="annotation-status" id="annotation-status">
                    <div class="status-idle">
                        <p>Select a type and press <kbd>S</kbd> to start</p>
                    </div>
                </div>

                <!-- Controls -->
                <div class="annotation-controls">
                    <!-- Range Mode Controls -->
                    <div id="range-mode-controls" class="mode-controls">
                        <button id="start-annotation-btn" class="btn btn-success btn-large" disabled>
                            <span>‚ñ∂</span> Start (S)
                        </button>
                        <button id="end-annotation-btn" class="btn btn-danger btn-large" disabled>
                            <span>‚èπ</span> End (E)
                        </button>
                    </div>
                    <!-- Pin Mode Controls -->
                    <div id="pin-mode-controls" class="mode-controls" style="display: none;">
                        <button id="pin-annotation-btn" class="btn btn-accent btn-large" disabled>
                            <span>üìç</span> Pin (M)
                        </button>
                    </div>
                </div>

                <!-- Horizontal Resize Handle -->
                <div id="annotations-resizer" class="horizontal-resizer"></div>

                <!-- Annotations List -->
                <div class="annotations-list-container">
                    <h3>Annotations <span id="annotation-count">(0)</span></h3>
                    <div class="annotations-list" id="annotations-list">
                        <!-- Dynamically generated -->
                    </div>
                </div>
            </aside>
        </main>

        <!-- Footer -->
        <footer class="app-footer">
            <div class="footer-info">
                <span id="modality-count">0 modalities</span>
            </div>
            <div class="keyboard-hints">
                <span><kbd>Space</kbd> Play/Pause</span>
                <span><kbd>‚Üê</kbd><kbd>‚Üí</kbd> Frame</span>
                <span id="hint-range"><kbd>S</kbd> Start <kbd>E</kbd> End</span>
                <span id="hint-pin" style="display: none;"><kbd>M</kbd> Pin</span>
            </div>
        </footer>

        <!-- Floating Resize Mode Indicator -->
        <div id="resize-mode-overlay" class="resize-mode-overlay">
            <span>üìê Resize Mode</span>
            <p>Drag the blue handles to resize panels</p>
            <button id="floating-exit-resize" class="btn btn-success">‚úì Done</button>
        </div>

        <!-- Data Type Picker Overlay -->
        <div id="data-type-picker" class="floating-picker">
            <span id="picker-title">üìä Select Data Type</span>
            <p id="picker-filename">filename.csv</p>
            <div class="picker-options">
                <button class="picker-option" data-type="overlay-gaze">
                    <span>üëÅ</span> Gaze
                </button>
                <button class="picker-option" data-type="overlay-heatmap">
                    <span>üî•</span> Heatmap
                </button>
                <button class="picker-option" data-type="timeseries-imu">
                    <span>üìà</span> IMU
                </button>
            </div>
            <button id="picker-cancel" class="btn btn-secondary">Cancel</button>
        </div>

        <!-- Parent Video Picker Overlay -->
        <div id="video-picker" class="floating-picker">
            <span>üé¨ Select Parent Video</span>
            <p id="video-picker-info">Which video should this overlay attach to?</p>
            <div id="video-picker-options" class="picker-options">
                <!-- Dynamically populated -->
            </div>
            <button id="video-picker-cancel" class="btn btn-secondary">Cancel</button>
        </div>

        <!-- Settings Modal -->
        <div id="settings-modal" class="modal">
            <div class="modal-content modal-large">
                <div class="modal-header">
                    <h2>‚öôÔ∏è Settings</h2>
                    <button id="settings-close" class="modal-close">√ó</button>
                </div>
                
                <!-- Settings Tabs -->
                <div class="settings-tabs">
                    <button class="settings-tab active" data-tab="layers">Layers</button>
                    <button class="settings-tab" data-tab="modalities">Modalities</button>
                    <button class="settings-tab" data-tab="pinmode">Pin Mode</button>
                    <button class="settings-tab" data-tab="gaze">Gaze</button>
                    <button class="settings-tab" data-tab="layout">Layout</button>
                </div>
                
                <div class="modal-body">
                    <!-- Layers Settings Pane -->
                    <div id="layers-settings" class="settings-pane">
                        <p class="settings-intro">Configure annotation layers and their types.</p>
                        <div id="layers-list" class="layers-list">
                            <!-- Dynamically generated -->
                        </div>
                        <div class="settings-actions">
                            <button id="add-layer-btn" class="btn btn-secondary">‚ûï Add Layer</button>
                            <button id="reset-layers-btn" class="btn btn-danger-outline">‚Üª Reset Defaults</button>
                        </div>
                    </div>
                    
                    <!-- Modalities Settings Pane -->
                    <div id="modalities-settings" class="settings-pane" style="display: none;">
                        <p class="settings-intro">Manage video streams and overlay modalities. Adjust offsets for synchronization.</p>
                        <div id="modalities-list" class="modalities-list">
                            <!-- Dynamically generated -->
                        </div>
                    </div>
                    
                    <!-- Pin Mode Settings Pane -->
                    <div id="pinmode-settings" class="settings-pane" style="display: none;">
                        <p class="settings-intro">Configure Pin Mode annotation window.</p>
                        <div class="pinmode-config">
                            <label>Window Size:</label>
                            <div class="window-input-group">
                                <input type="number" id="pin-window-value" value="1" min="0" step="1" class="window-input">
                                <select id="pin-window-unit" class="window-unit-select">
                                    <option value="frames" selected>frames</option>
                                    <option value="seconds">seconds</option>
                                    <option value="ms">milliseconds</option>
                                </select>
                            </div>
                            <p class="settings-hint">Annotation will span from current frame ¬± this window.</p>
                        </div>
                    </div>
                    
                    <!-- Gaze Processing Settings Pane -->
                    <div id="gaze-settings" class="settings-pane" style="display: none;">
                        <p class="settings-intro">Configure gaze data post-processing: smoothing and fixation detection.</p>
                        
                        <!-- Temporal Sync -->
                        <div class="gaze-config-section">
                            <h3>Temporal Sync</h3>
                            <p class="settings-hint">Auto-aligned on load. Fine-tune manually if needed.</p>
                            <div class="gaze-param-row gaze-sync-row">
                                <label>Offset:</label>
                                <span id="gaze-offset-display" class="gaze-offset-value">0 ms</span>
                            </div>
                            <div class="gaze-sync-buttons">
                                <button class="gaze-sync-btn" onclick="adjustGazeOffset(-100)">‚àí100ms</button>
                                <button class="gaze-sync-btn" onclick="adjustGazeOffset(-10)">‚àí10ms</button>
                                <button class="gaze-sync-btn gaze-sync-reset" onclick="adjustGazeOffset(-state.modalities.find(m=>m.type==='overlay-gaze')?.offsetMs||0)">Reset</button>
                                <button class="gaze-sync-btn" onclick="adjustGazeOffset(10)">+10ms</button>
                                <button class="gaze-sync-btn" onclick="adjustGazeOffset(100)">+100ms</button>
                            </div>
                        </div>

                        <!-- Smoothing Filter -->
                        <div class="gaze-config-section">
                            <h3>Smoothing Filter</h3>
                            <div class="gaze-param-row">
                                <label>Filter Type:</label>
                                <select id="gaze-filter-type" class="gaze-select" onchange="updateGazeConfig('filter', this.value)">
                                    <option value="none">None</option>
                                    <option value="moving-average" selected>Moving Average</option>
                                    <option value="median">Median</option>
                                </select>
                            </div>
                            <div class="gaze-param-row">
                                <label>Window Size:</label>
                                <input type="number" id="gaze-filter-window" class="gaze-input" value="5" min="1" max="30" step="1"
                                       onchange="updateGazeConfig('filterWindow', parseInt(this.value))">
                                <span class="gaze-unit">samples</span>
                            </div>
                        </div>

                        <!-- Fixation Detection -->
                        <div class="gaze-config-section">
                            <h3>Fixation Detection</h3>
                            <div class="gaze-param-row">
                                <label>Algorithm:</label>
                                <select id="gaze-fixation-algo" class="gaze-select" onchange="updateGazeConfig('fixationAlgo', this.value)">
                                    <option value="none">None (Raw Gaze Only)</option>
                                    <option value="ivt" selected>I-VT (Velocity Threshold)</option>
                                    <option value="idt">I-DT (Dispersion Threshold)</option>
                                </select>
                            </div>
                            
                            <!-- I-VT Parameters -->
                            <div id="ivt-params" class="gaze-algo-params">
                                <div class="gaze-param-row">
                                    <label>Velocity Threshold:</label>
                                    <input type="number" id="gaze-ivt-threshold" class="gaze-input" value="0.5" min="0.01" max="5" step="0.05"
                                           onchange="updateGazeConfig('ivtThreshold', parseFloat(this.value))">
                                    <span class="gaze-unit">norm/s</span>
                                </div>
                            </div>

                            <!-- I-DT Parameters -->
                            <div id="idt-params" class="gaze-algo-params" style="display: none;">
                                <div class="gaze-param-row">
                                    <label>Dispersion Threshold:</label>
                                    <input type="number" id="gaze-idt-dispersion" class="gaze-input" value="0.03" min="0.005" max="0.2" step="0.005"
                                           onchange="updateGazeConfig('idtDispersion', parseFloat(this.value))">
                                    <span class="gaze-unit">normalized</span>
                                </div>
                                <div class="gaze-param-row">
                                    <label>Min Duration:</label>
                                    <input type="number" id="gaze-idt-min-duration" class="gaze-input" value="100" min="10" max="1000" step="10"
                                           onchange="updateGazeConfig('idtMinDuration', parseInt(this.value))">
                                    <span class="gaze-unit">ms</span>
                                </div>
                            </div>
                        </div>

                        <!-- Display Options -->
                        <div class="gaze-config-section">
                            <h3>Display</h3>
                            <div class="gaze-param-row">
                                <label>
                                    <input type="checkbox" id="gaze-show-raw" onchange="updateGazeConfig('showRawGaze', this.checked)">
                                    Show raw/filtered gaze trail
                                </label>
                            </div>
                            <div class="gaze-param-row">
                                <label>
                                    <input type="checkbox" id="gaze-show-fixations" checked onchange="updateGazeConfig('showFixations', this.checked)">
                                    Show fixation circles
                                </label>
                            </div>
                            <div class="gaze-param-row">
                                <label>Fixation Size:</label>
                                <select id="gaze-fixation-size-mode" class="gaze-select" onchange="updateGazeConfig('fixationSizeMode', this.value)">
                                    <option value="proportional" selected>Proportional to Duration</option>
                                    <option value="fixed">Fixed Size</option>
                                </select>
                            </div>
                        </div>

                        <!-- Stats -->
                        <div class="gaze-config-section">
                            <h3>Gaze Stats</h3>
                            <div id="gaze-stats" class="gaze-stats">
                                <p class="settings-hint">Load gaze data to see statistics.</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Layout Settings Pane -->
                    <div id="layout-settings" class="settings-pane" style="display: none;">
                        <p class="settings-intro">Adjust panel sizes by dragging the resize handles.</p>
                        <div class="layout-controls">
                            <button id="toggle-resize-mode" class="btn btn-primary btn-large">
                                <span>üìê</span> Enter Resize Mode
                            </button>
                            <p class="resize-hint" id="resize-hint" style="display: none;">
                                Drag the blue handles to resize panels, then click "Done" below.
                            </p>
                            <button id="exit-resize-mode" class="btn btn-success btn-large" style="display: none;">
                                ‚úì Done Resizing
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="app.js"></script>
    <script src="tests.js"></script>
</body>
</html>
